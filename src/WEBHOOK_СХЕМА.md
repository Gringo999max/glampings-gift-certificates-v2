# 🔄 Схема работы Webhook системы

## 📊 Общая архитектура

```
┌─────────────────────────────────────────────────────────────┐
│                     FRONTEND (Браузер)                      │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  CorporateRequestFormModal.tsx                       │  │
│  │                                                      │  │
│  │  1. Пользователь заполняет форму:                   │  │
│  │     • Имя                                            │  │
│  │     • Компания                                       │  │
│  │     • Email                                          │  │
│  │     • Телефон                                        │  │
│  │     • Количество сотрудников (опционально)           │  │
│  │     • Сообщение (опционально)                        │  │
│  │                                                      │  │
│  │  2. Нажимает "Отправить заявку"                      │  │
│  └──────────────────┬───────────────────────────────────┘  │
│                     │                                       │
│                     ↓                                       │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  webhookService.ts                                   │  │
│  │                                                      │  │
│  │  sendCorporateRequest(formData, source)              │  │
│  │                                                      │  │
│  │  • Добавляет timestamp (ISO 8601)                    │  │
│  │  • Добавляет source (напр. "corporate_modal")        │  │
│  │  • Добавляет userAgent                               │  │
│  │  • Добавляет pageUrl                                 │  │
│  │                                                      │  │
│  │  📤 Отправляет POST запрос                           │  │
│  └──────────────────┬───────────────────────────────────┘  │
│                     │                                       │
└─────────────────────┼───────────────────────────────────────┘
                      │
                      │ HTTP POST
                      │ Content-Type: application/json
                      │
                      ↓
┌─────────────────────────────────────────────────────────────┐
│                  WEBHOOK ENDPOINT                           │
│                (Ваш сервер или сервис)                      │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  URL из /config/webhooks.ts:                                │
│  https://your-webhook-url.com/api/corporate-requests        │
│                                                             │
│  Получает JSON:                                             │
│  {                                                          │
│    "name": "Иван Петров",                                   │
│    "company": "ООО Компания",                               │
│    "email": "ivan@company.ru",                              │
│    "phone": "+7 (912) 345-67-89",                           │
│    "employees": "150",                                      │
│    "message": "Текст...",                                   │
│    "timestamp": "2025-11-07T14:30:00.000Z",                 │
│    "source": "corporate_modal"                              │
│  }                                                          │
│                                                             │
└──────────────────┬──────────────────────────────────────────┘
                   │
                   ↓
┌─────────────────────────────────────────────────────────────┐
│              ОБРАБОТКА НА СЕРВЕРЕ                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Варианты обработки:                                        │
│                                                             │
│  📧 Email уведомления                                       │
│  💾 Сохранение в базу данных                                │
│  📊 Google Sheets / Airtable / Notion                       │
│  💬 Уведомления в Slack / Telegram                          │
│  🔄 Интеграция с CRM (amoCRM, Битрикс24 и т.д.)             │
│  📈 Аналитика и отчётность                                  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 🔀 Детальный Flow

```
Пользователь на сайте
        │
        ↓
Открывает страницу "Корпоративные подарки"
        │
        ↓
Нажимает "Оставить заявку"
        │
        ↓
Открывается модальное окно (CorporateRequestFormModal)
        │
        ↓
Заполняет форму:
  • Имя ✓
  • Компания ✓
  • Email ✓
  • Телефон ✓
  • Количество сотрудников (опционально)
  • Сообщение (опционально)
        │
        ↓
Нажимает "Отправить заявку"
        │
        ↓
┌───────────────────────────┐
│   ВАЛИДАЦИЯ ФОРМЫ         │
│                           │
│  • Проверка email         │
│  • Проверка телефона      │
│  • Проверка обязательных  │
│    полей                  │
└───────────┬───────────────┘
            │
            ↓
      Валидация OK?
            │
      ┌─────┴─────┐
      │           │
     Нет         Да
      │           │
      ↓           ↓
 Показать   sendCorporateRequest()
  ошибки          │
      ↑           ↓
      │    Добавление метаданных:
      │    • timestamp
      │    • source
      │    • userAgent
      │    • pageUrl
      │           │
      │           ↓
      │    POST запрос на webhook
      │           │
      │           ↓
      │    ┌─────────────┐
      │    │   WEBHOOK   │
      │    │   ENDPOINT  │
      │    └──────┬──────┘
      │           │
      │      ┌────┴────┐
      │      │         │
      │    Успех    Ошибка
      │      │         │
      │      ↓         ↓
      │  ✅ Успех   ❌ Лог ошибки
      │      │         │
      └──────┴─────────┘
             │
             ↓
   Показать экран успеха
             │
             ↓
   Через 2 сек закрыть модалку
```

---

## 🏗️ Архитектура компонентов

```
┌──────────────────────────────────────────────────────────────┐
│                    КОНФИГУРАЦИЯ                              │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  /config/webhooks.ts                                         │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ export const CORPORATE_REQUEST_WEBHOOK_URL =           │ │
│  │   'https://your-webhook.com/api/corporate-requests'    │ │
│  │                                                        │ │
│  │ export const WEBHOOK_URLS = {                          │ │
│  │   production: 'https://api.prod.com/webhook',          │ │
│  │   staging: 'https://api.staging.com/webhook',          │ │
│  │   development: 'http://localhost:3000/webhook'         │ │
│  │ }                                                      │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                              │
└──────────────────────────────────────────────────────────────┘
                              │
                              │ импортирует
                              ↓
┌──────────────────────────────────────────────────────────────┐
│                     СЕРВИСНЫЙ СЛОЙ                           │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  /utils/webhookService.ts                                    │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ interface CorporateRequestData { ... }                 │ │
│  │                                                        │ │
│  │ export async function sendCorporateRequest(            │ │
│  │   formData,                                            │ │
│  │   source                                               │ │
│  │ ): Promise<{ success: boolean; error?: string }>       │ │
│  │                                                        │ │
│  │ • Формирует requestData                                │ │
│  │ • Добавляет метаданные                                 │ │
│  │ • Отправляет fetch() запрос                            │ │
│  │ • Обрабатывает ответ                                   │ │
│  │ • Возвращает результат                                 │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                              │
└──────────────────────────────────────────────────────────────┘
                              │
                              │ использует
                              ↓
┌──────────────────────────────────────────────────────────────┐
│                   КОМПОНЕНТ ФОРМЫ                            │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  /components/CorporateRequestFormModal.tsx                   │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ import { sendCorporateRequest } from '../utils/...'    │ │
│  │                                                        │ │
│  │ const handleSubmit = async (e) => {                    │ │
│  │   // Валидация                                         │ │
│  │   const result = await sendCorporateRequest(           │ │
│  │     formData,                                          │ │
│  │     'corporate_modal'                                  │ │
│  │   );                                                   │ │
│  │                                                        │ │
│  │   if (result.success) {                                │ │
│  │     setSubmitSuccess(true);                            │ │
│  │   }                                                    │ │
│  │ }                                                      │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

---

## 🌐 Варианты интеграции

```
                    WEBHOOK ENDPOINT
                          │
         ┌────────────────┼────────────────┐
         │                │                │
         ↓                ↓                ↓
    ┌─────────┐      ┌─────────┐     ┌──────────┐
    │ Zapier  │      │   n8n   │     │   Make   │
    └────┬────┘      └────┬────┘     └────┬─────┘
         │                │                │
         ↓                ↓                ↓
   ┌──────────┐     ┌──────────┐    ┌──────────┐
   │ Google   │     │ Custom   │    │ Visual   │
   │ Sheets   │     │ Workflow │    │ Workflow │
   │    +     │     │    +     │    │    +     │
   │  Email   │     │  CRM     │    │  Router  │
   └──────────┘     └──────────┘    └──────────┘


                    ИЛИ


               WEBHOOK ENDPOINT
                      │
                      ↓
              ┌───────────────┐
              │ Ваш Backend   │
              │  (Node.js /   │
              │   Python)     │
              └───────┬───────┘
                      │
        ┌─────────────┼─────────────┐
        │             │             │
        ↓             ↓             ↓
   ┌─────────┐  ┌─────────┐  ┌─────────┐
   │Database │  │  Email  │  │   CRM   │
   │(MongoDB)│  │ Service │  │ (API)   │
   └─────────┘  └─────────┘  └─────────┘
```

---

## 📋 Жизненный цикл заявки

```
1. СОЗДАНИЕ
   ↓
   Пользователь заполняет форму
   
2. ВАЛИДАЦИЯ
   ↓
   Проверка обязательных полей
   Проверка формата email
   Проверка формата телефона
   
3. ОБОГАЩЕНИЕ
   ↓
   Добавление timestamp
   Добавление source
   Добавление userAgent
   Добавление pageUrl
   
4. ОТПРАВКА
   ↓
   POST запрос на webhook
   
5. ОБРАБОТКА
   ↓
   Сервер получает данные
   Валидирует
   Сохраняет в БД / Sheets
   Отправляет уведомления
   
6. ПОДТВЕРЖДЕНИЕ
   ↓
   Ответ { success: true }
   
7. ОТОБРАЖЕНИЕ
   ↓
   Экран успеха для пользователя
```

---

## 🔄 Варианты использования данных

```
                  ЗАЯВКА ПОЛУЧЕНА
                         │
         ┌───────────────┼───────────────┐
         │               │               │
         ↓               ↓               ↓
    ┌─────────┐     ┌─────────┐    ┌─────────┐
    │СОХРАНИТЬ│     │ОТПРАВИТЬ│    │СОЗДАТЬ  │
    │         │     │         │    │         │
    │• Google │     │• Email  │    │• CRM    │
    │  Sheets │     │  менедж.│    │  Lead   │
    │         │     │         │    │         │
    │• Airtable     │• Slack  │    │• Notion │
    │         │     │  канал  │    │  запись │
    │         │     │         │    │         │
    │• База   │     │• Telegram    │• Задача │
    │  данных │     │  бот    │    │  в ПМ   │
    └─────────┘     └─────────┘    └─────────┘
         │               │               │
         └───────────────┼───────────────┘
                         ↓
                  ГОТОВО К РАБОТЕ
```

---

## 🎯 Примеры сценариев

### Сценарий 1: Простой (Стартап)
```
Webhook → Google Sheets
        ↓
   Email менеджеру
```

### Сценарий 2: Средний (Малый бизнес)
```
Webhook → Zapier → Router
                    ├─→ Google Sheets (все заявки)
                    └─→ Email (уведомление)
```

### Сценарий 3: Продвинутый (Средний бизнес)
```
Webhook → n8n → Filter (кол-во сотрудников)
                 ├─→ > 100: Slack #vip-leads + Email CEO
                 └─→ < 100: Google Sheets + Email менеджера
```

### Сценарий 4: Enterprise
```
Webhook → Backend API → Validation
                         ↓
                    PostgreSQL
                         ↓
                   ┌─────┴─────┐
                   ↓           ↓
              CRM (API)    Email Service
                   ↓           ↓
              Analytics   Slack/Telegram
```

---

**Диаграммы помогают понять архитектуру системы! 📊**
